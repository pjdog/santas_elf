#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"
ENV_TEMPLATE="$SCRIPT_DIR/.env.template"

# Prefer modern Docker Compose plugin; fallback to bundled v2 binary if present; else legacy docker-compose
PLUGIN_BIN="$HOME/.docker/cli-plugins/docker-compose"
if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
  COMPOSE="docker compose"
elif [ -x "$PLUGIN_BIN" ]; then
  COMPOSE="$PLUGIN_BIN"
else
  COMPOSE="docker-compose"
fi

# Explicitly set API version to satisfy newer daemons when old clients are present
export DOCKER_API_VERSION=${DOCKER_API_VERSION:-1.44}

# Check for required tools
check_tools() {
    for tool in docker lsof; do
        if ! command -v "$tool" &> /dev/null; then
            echo "Error: $tool is not installed. Please install '$tool'." >&2
            exit 1
        fi
    done
}

ensure_env() {
  if [[ ! -f "$ENV_FILE" ]];
  then
    if [[ ! -f "$ENV_TEMPLATE" ]];
    then
      echo "Environment template $ENV_TEMPLATE is missing." >&2
      exit 1
    fi
    cp "$ENV_TEMPLATE" "$ENV_FILE"
    echo "Created .env from template. Update $ENV_FILE if you need custom values."
  fi
}

usage() {
  echo "Usage: $0 {up|down|restart|clean|logs|fix-ports|test|status|install|agent}" >&2
  echo "  up         : Start the application"
  echo "  down       : Stop the application (removes orphans)"
  echo "  restart    : Restart the application"
  echo "  clean      : Stop app, remove volumes (resets DB)"
  echo "  logs       : Follow container logs"
  echo "  fix-ports  : Force kill processes hogging ports 3000 or 5000 (Use if 'up' fails)"
  echo "  test       : Run server and client test suites in Docker (non-interactive)"
  echo "  status     : Show container status and log file locations"
  echo "  install    : Check local prerequisites and suggest install commands"
  echo "  agent      : Run the agent CLI locally (uses CLI_SECRET and AGENT_BASE_URL)"
  echo ""
  echo "Options for 'up':"
  echo "  --no-cache : Rebuild without cache"
  exit 1
}

# Parse args
ACTION="${1:-}" || true
shift || true

# Ensure we have tools before running potentially destructive commands
if [[ "$ACTION" == "fix-ports" ]]; then
    check_tools
fi

case "$ACTION" in
  up)
    ensure_env
    
    if [[ "${1:-}" == "--no-cache" ]]; then
        echo "Rebuilding without cache..."
        (cd "$SCRIPT_DIR" && ${COMPOSE} build --no-cache)
        shift
    fi
    
    echo "Starting application..."
    (cd "$SCRIPT_DIR" && ${COMPOSE} up -d --build --remove-orphans)
    cat <<'EOF'
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†§‚†§‚†§‚†§‚†§‚¢§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∫‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†¶‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢≥‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢¢‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ú‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†ü‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†ò‚¢æ‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚£ä‚†Å‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚†§‚†§‚†î‚†í‚†í‚†ö‚†â‚†â‚†â‚†â‚†â‚†â‚†â‚†Å‚†Ä‚†Ä‚†â‚†ì‚†¶‚°Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†í‚†â‚†Å‚†Ä‚†à‚†â‚†â‚†â‚†Å‚†Ä‚£Ä‚£Ä‚£Ä‚°§‚†§‚†§‚†¥‚†í‚†í‚†≤‚†§‚†§‚¢§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£à‚°Ü‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£π‚¢§‚¢§‚£Ä‚£Ä‚£Ä‚£†‚£§‚†¥‚¢≤‚£è‚£Ω‚†ß‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°∂‚°¶‚¢§‚°Ä‚†π‚°ü‚¢ñ‚†í‚†í‚¢ª‚°Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚¢º‚†Å‚†Ä‚°Ω‚£ø‚£º‚†É‚†Ä‚†π‚†ø‚†∑‚†ü‚†õ‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†õ‚†ö‚†æ‚†Ü‚£∑‚†∏‚°Ö‚†ô‚¢¶‚°á‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚°á‚¢à‚¢§‚°û‚°ù‚£´‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚£∂‚£§‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£∂‚£Ç‚†Ä‚†Ä‚¢∏‚†Ä‚¢ª‚°Ñ‚£æ‚°á‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£û‚£ò‚£æ‚£ï‚°ø‚°∏‚†Ä‚†Ä‚†Ä‚†Ä‚†∫‚†ø‚£ø‚†ó‚†Ä‚¢Ä‚£†‚†§‚¢Ñ‚°ò‚¢ø‚£ø‚†ü‚†Ä‚†Ä‚†à‚°Ü‚¢∏‚£ü‚°ø‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ü‚°æ‚°û‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†Ä‚£†‚†è‚†Ä‚†Ä‚†Ä‚†ë‚£ü‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚¢±‚†Ä‚£Ø‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚£ø‚£º‚£ò‚°Å‚†Ä‚¢ß‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚°ø‚£ñ‚†¶‚†§‚¢ñ‚£≤‚¢Ø‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚¢∏‚°Ñ‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£†‚†ñ‚†ã‚†Å‚†Ä‚†Ä‚†Ä‚†â‚†ì‚¢§‚†ô‚†í‚¢í‚£í‚£í‚°ø‚£ù‚°Ø‚†ã‚†Å‚£Ä‚£Ä‚°Ä‚†â‚†ª‚£Ø‚¢ç‚†ë‚†í‚¢¥‚°ö‚†í‚¢∏‚†É‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∞‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£∑‚†Ä‚†à‚†©‚†ì‚†ã‚£Å‚°†‚†¥‚£è‚£Å‚£à‚£©‚†∑‚†¶‚£à‚°ö‚†Ω‚¢ñ‚†§‚†§‚£†‚£ø‚°Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ò‚£∑‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†è‚¢ë‚°ñ‚†í‚†í‚£´‚†è‚†Ä‚†Ä‚†Ä‚†∏‚°Ü‚†Ä‚†Ä‚†Ä‚†à‚¢â‚†í‚†í‚†í‚†í‚†Å‚¢∏‚†ô‚£Ü‚†Ä‚†Ä
‚†Ä‚¢Ä‚£¥‚°ø‚†ö‚†¶‚†§‚†§‚†§‚†§‚¢§‚†û‚†ã‚¢†‚†ã‚†Ä‚£∞‚¢≤‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚†Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚†≥‚°Ä‚†Ä‚†Ä‚†Ä‚£†‚°á‚†ò‚£Ñ‚†Ä
‚£†‚°ü‚°û‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚°É‚¢Ä‚°ü‚†Ä‚£∞‚†É‚£Ω‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢£‚†Ä‚†Ä‚†Ä‚¢ª‚¢ø‚£Ø‚£Ω‚†Ω‚†∂‚£Ñ‚†Ä‚†Ä‚†Ä
‚¢Ω‚°á‚†á‚†Ä‚†ê‚†í‚†í‚†í‚†í‚†ã‚†Å‚£ª‚°é‚†Å‚¢†‚†É‚†Ä‚¢π‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†è‚†Ä‚†Ä‚£á‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚¢¥‚°æ‚†Ä‚¢∑‚°â‚¢±‚°Ä‚†à‚†≥‚£Ñ‚†Ä
‚¢∏‚†Ä‚°á‚†Ä‚†Ä‚¢§‚£Ä‚£Ä‚£Ä‚£Ä‚†î‚¢π‚°ß‚°Ñ‚†∏‚°Ñ‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°û‚†Ä‚†Ä‚†Ä‚£ø‚†Ä‚†Ä‚°é‚†Ä‚¢∞‚£∏‚¢ß‚†â‚†ô‚£ü‚†ä‚¢Å‚£¥‚†Ü‚†à‚£á
‚†ò‚£á‚†π‚£Ü‚†Ä‚£Ä‚°à‚†â‚†â‚¢Ä‚£†‚°õ‚†Ä‚†ô‚†≤‚£è‚†Ä‚†ò‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚°û‚†Ä‚†Ä‚†Ä‚¢†‚°è‚†Ä‚†Ä‚°á‚£Ñ‚£¥‚†ã‚¢à‚°∑‚†Ä‚£ø‚†Ä‚†Ä‚£ª‚°§‚¢¥‚°è
‚†Ä‚†ò‚†¶‚£à‚££‚£å‚£â‚†í‚†ö‚†â‚£∏‚†Å‚†Ä‚†Ä‚†Ä‚†ò‚¢¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†É‚†Ä‚†Ä‚†Ä‚°û‚†Ä‚†Ä‚†Ä‚¢Å‚°ø‚†Å‚†Ä‚£º‚°Ä‚†Ä‚†Ä‚¢Ä‚£∏‚£è‚†Ä‚£†‚†á
‚†Ä‚†Ä‚†Ä‚†Ä‚¢â‚°è‚†â‚†â‚°π‚†â‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢¶‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚†Ä‚°∏‚†Å‚†Ä‚†Ä‚£∫‚†ã‚†Ä‚†Ä‚£¥‚†É‚†ô‚†¢‚£Ñ‚£à‚£ø‚†â‚£ø‚°ü‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚°ú‚†Ä‚†Ä‚¢†‚†É‚¢∞‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†£‚£Ñ‚°Ä‚†à‚†Ä‚¢Ä‚†ú‚†Å‚¢Ä‚°§‚†¥‚†ã‚†Ä‚¢Ä‚£ú‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†ª‚†º‚†ø‚†â‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚°á‚†Ä‚¢Ä‚†è‚†Ä‚†à‚°£‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†¢‚°Ä‚¢ã‚°§‚†î‚†ä‚¢Ä‚£Ä‚°§‚†ñ‚†Å‚¢π‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£æ‚†Ä‚†Ä‚°ú‚†Ä‚¢†‚°è‚†Ä‚†Ä‚†â‚†â‚†â‚†í‚†í‚†í‚†§‚†§‚†§‚°§‚†§‚†Ω‚†ü‚†í‚†í‚†â‚†â‚†Ä‚†Ä‚¢Ä‚°§‚†ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚°ü‚†Ä‚£∞‚†Å‚†Ä‚¢®‚†á‚†¶‚†§‚£Ñ‚£Ä‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚†§‚†ö‚†ô‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚°á‚¢Ä‚°è‚†Ä‚†Ä‚°é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚†ë‚†í‚†í‚†ö‚†â‚°á‚†ê‚†í‚†í‚†â‚†â‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†¶‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢†‚°á‚†∏‚†Ä‚¢Ä‚°º‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†í‚¢§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚†Å‚£†‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚£∞‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£á‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£î‚°ã‚†ô‚†í‚†¶‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ω‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ò‚¢ß‚£Ä‚£∑‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚¢è‚°º‚†õ‚†í‚†§‚¢Ñ‚£Ä‚†â‚†í‚†¢‚†§‚¢Ñ‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚†§‚¢ú‚°ø‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ø‚£à‚†ô‚†í‚†¶‚†§‚†§‚†§‚†§‚†§‚†§‚†î‚¢ä‚°µ‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†í‚†¢‚†§‚†§‚†§‚†§‚†§‚†§‚†§‚†§‚†¥‚†ö‚†Å‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†ô‚†í‚†í‚†í‚†í‚†í‚†í‚†í‚†í‚†Ç‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
EOF
    echo "‚úÖ Application started: http://localhost:8080"
    ;;
  down)
    echo "Stopping application..."
    (cd "$SCRIPT_DIR" && ${COMPOSE} down --remove-orphans)
    echo "‚úÖ Application stopped."
    ;;
  restart)
    echo "Restarting application..."
    (cd "$SCRIPT_DIR" && ${COMPOSE} down --remove-orphans)
    ensure_env
    (cd "$SCRIPT_DIR" && ${COMPOSE} up -d --build --remove-orphans)
    cat <<'EOF'
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†§‚†§‚†§‚†§‚†§‚¢§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∫‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†¶‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢≥‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢¢‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢¶‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£≥‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£∞‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£ú‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚†ü‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£Ä‚£Ä‚£Ä‚£Ä‚°Ä‚†Ä‚†ò‚¢æ‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚£ä‚†Å‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚†§‚†§‚†î‚†í‚†í‚†ö‚†â‚†â‚†â‚†â‚†â‚†â‚†Å‚†Ä‚†Ä‚†â‚†ì‚†¶‚°Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†í‚†â‚†Å‚†Ä‚†à‚†â‚†â‚†â‚†Å‚†Ä‚£Ä‚£Ä‚£Ä‚°§‚†§‚†§‚†¥‚†í‚†í‚†≤‚†§‚†§‚¢§‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£à‚°Ü‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£π‚¢§‚¢§‚£Ä‚£Ä‚£Ä‚£†‚£§‚†¥‚¢≤‚£è‚£Ω‚†ß‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚°∂‚°¶‚¢§‚°Ä‚†π‚°ü‚¢ñ‚†í‚†í‚¢ª‚°Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚°á‚¢º‚†Å‚†Ä‚°Ω‚£ø‚£º‚†É‚†Ä‚†π‚†ø‚†∑‚†ü‚†õ‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†õ‚†ö‚†æ‚†Ü‚£∑‚†∏‚°Ö‚†ô‚¢¶‚°á‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†∏‚°á‚¢à‚¢§‚°û‚°ù‚£´‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚¢∞‚£∂‚£§‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£¥‚£∂‚£Ç‚†Ä‚†Ä‚¢∏‚†Ä‚¢ª‚°Ñ‚£æ‚°á‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†π‚£û‚£ò‚£æ‚£ï‚°ø‚°∏‚†Ä‚†Ä‚†Ä‚†Ä‚†∫‚†ø‚£ø‚†ó‚†Ä‚¢Ä‚£†‚†§‚¢Ñ‚°ò‚¢ø‚£ø‚†ü‚†Ä‚†Ä‚†à‚°Ü‚¢∏‚£ü‚°ø‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£æ‚£ü‚°æ‚°û‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†Ä‚£†‚†è‚†Ä‚†Ä‚†Ä‚†ë‚£ü‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚¢±‚†Ä‚£Ø‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚£ø‚£º‚£ò‚°Å‚†Ä‚¢ß‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚°ø‚£ñ‚†¶‚†§‚¢ñ‚£≤‚¢Ø‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚¢∏‚°Ñ‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£†‚†ñ‚†ã‚†Å‚†Ä‚†Ä‚†Ä‚†â‚†ì‚¢§‚†ô‚†í‚¢í‚£í‚£í‚°ø‚£ù‚°Ø‚†ã‚†Å‚£Ä‚£Ä‚°Ä‚†â‚†ª‚£Ø‚¢ç‚†ë‚†í‚¢¥‚°ö‚†í‚¢∏‚†É‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∞‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£∑‚†Ä‚†à‚†©‚†ì‚†ã‚£Å‚°†‚†¥‚£è‚£Å‚£à‚£©‚†∑‚†¶‚£à‚°ö‚†Ω‚¢ñ‚†§‚†§‚£†‚£ø‚°Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ò‚£∑‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚†è‚¢ë‚°ñ‚†í‚†í‚£´‚†è‚†Ä‚†Ä‚†Ä‚†∏‚°Ü‚†Ä‚†Ä‚†Ä‚†à‚¢â‚†í‚†í‚†í‚†í‚†Å‚¢∏‚†ô‚£Ü‚†Ä‚†Ä
‚†Ä‚¢Ä‚£¥‚°ø‚†ö‚†¶‚†§‚†§‚†§‚†§‚¢§‚†û‚†ã‚¢†‚†ã‚†Ä‚£∞‚¢≤‚†á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢π‚†Ä‚†Ä‚¢Ä‚†Ä‚†Ä‚†≥‚°Ä‚†Ä‚†Ä‚†Ä‚£†‚°á‚†ò‚£Ñ‚†Ä
‚£†‚°ü‚°û‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£º‚°É‚¢Ä‚°ü‚†Ä‚£∞‚†É‚£Ω‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢£‚†Ä‚†Ä‚†Ä‚¢ª‚¢ø‚£Ø‚£Ω‚†Ω‚†∂‚£Ñ‚†Ä‚†Ä‚†Ä
‚¢Ω‚°á‚†á‚†Ä‚†ê‚†í‚†í‚†í‚†í‚†ã‚†Å‚£ª‚°é‚†Å‚¢†‚†É‚†Ä‚¢π‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†è‚†Ä‚†Ä‚£á‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚¢¥‚°æ‚†Ä‚¢∑‚°â‚¢±‚°Ä‚†à‚†≥‚£Ñ‚†Ä
‚¢∏‚†Ä‚°á‚†Ä‚†Ä‚¢§‚£Ä‚£Ä‚£Ä‚£Ä‚†î‚¢π‚°ß‚°Ñ‚†∏‚°Ñ‚†Ä‚¢∏‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°û‚†Ä‚†Ä‚†Ä‚£ø‚†Ä‚†Ä‚°é‚†Ä‚¢∞‚£∏‚¢ß‚†â‚†ô‚£ü‚†ä‚¢Å‚£¥‚†Ü‚†à‚£á
‚†ò‚£á‚†π‚£Ü‚†Ä‚£Ä‚°à‚†â‚†â‚¢Ä‚£†‚°õ‚†Ä‚†ô‚†≤‚£è‚†Ä‚†ò‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚°û‚†Ä‚†Ä‚†Ä‚¢†‚°è‚†Ä‚†Ä‚°á‚£Ñ‚£¥‚†ã‚¢à‚°∑‚†Ä‚£ø‚†Ä‚†Ä‚£ª‚°§‚¢¥‚°è
‚†Ä‚†ò‚†¶‚£à‚££‚£å‚£â‚†í‚†ö‚†â‚£∏‚†Å‚†Ä‚†Ä‚†Ä‚†ò‚¢¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚†É‚†Ä‚†Ä‚†Ä‚°û‚†Ä‚†Ä‚†Ä‚¢Å‚°ø‚†Å‚†Ä‚£º‚°Ä‚†Ä‚†Ä‚¢Ä‚£∏‚£è‚†Ä‚£†‚†á
‚†Ä‚†Ä‚†Ä‚†Ä‚¢â‚°è‚†â‚†â‚°π‚†â‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚¢¶‚†Ä‚†Ä‚†Ä‚¢∏‚†Ä‚†Ä‚†Ä‚°∏‚†Å‚†Ä‚†Ä‚£∫‚†ã‚†Ä‚†Ä‚£¥‚†É‚†ô‚†¢‚£Ñ‚£à‚£ø‚†â‚£ø‚°ü‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚°ú‚†Ä‚†Ä‚¢†‚†É‚¢∞‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†£‚£Ñ‚°Ä‚†à‚†Ä‚¢Ä‚†ú‚†Å‚¢Ä‚°§‚†¥‚†ã‚†Ä‚¢Ä‚£ú‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†ª‚†º‚†ø‚†â‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚¢Ä‚°á‚†Ä‚¢Ä‚†è‚†Ä‚†à‚°£‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†¢‚°Ä‚¢ã‚°§‚†î‚†ä‚¢Ä‚£Ä‚°§‚†ñ‚†Å‚¢π‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚£æ‚†Ä‚†Ä‚°ú‚†Ä‚¢†‚°è‚†Ä‚†Ä‚†â‚†â‚†â‚†í‚†í‚†í‚†§‚†§‚†§‚°§‚†§‚†Ω‚†ü‚†í‚†í‚†â‚†â‚†Ä‚†Ä‚¢Ä‚°§‚†ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚°ü‚†Ä‚£∞‚†Å‚†Ä‚¢®‚†á‚†¶‚†§‚£Ñ‚£Ä‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£∑‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚†§‚†ö‚†ô‚£á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚°á‚¢Ä‚°è‚†Ä‚†Ä‚°é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†â‚†ë‚†í‚†í‚†ö‚†â‚°á‚†ê‚†í‚†í‚†â‚†â‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†ô‚†¶‚£Ä‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢†‚°á‚†∏‚†Ä‚¢Ä‚°º‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†í‚¢§‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚†Å‚£†‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚£∞‚†É‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚£á‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚¢∏‚°á‚¢ª‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£î‚°ã‚†ô‚†í‚†¶‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ω‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†ò‚¢ß‚£Ä‚£∑‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚¢è‚°º‚†õ‚†í‚†§‚¢Ñ‚£Ä‚†â‚†í‚†¢‚†§‚¢Ñ‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚£Ä‚†§‚¢ú‚°ø‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚¢ø‚£à‚†ô‚†í‚†¶‚†§‚†§‚†§‚†§‚†§‚†§‚†î‚¢ä‚°µ‚†ã‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†à‚†â‚†í‚†í‚†¢‚†§‚†§‚†§‚†§‚†§‚†§‚†§‚†§‚†¥‚†ö‚†Å‚†Ä‚†Ä‚†Ä‚†Ä
‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚†ô‚†í‚†í‚†í‚†í‚†í‚†í‚†í‚†í‚†Ç‚†â‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä
EOF
    echo "‚úÖ Application restarted: http://localhost:8080"
    ;;
  clean)
    echo "Cleaning application state..."
    (cd "$SCRIPT_DIR" && ${COMPOSE} down -v --remove-orphans)
    echo "‚úÖ Application cleaned (volumes removed)."
    ;;
  logs)
    (cd "$SCRIPT_DIR" && ${COMPOSE} logs -f)
    ;;
  fix-ports)
    echo "üîç Checking for stuck processes on ports 3000, 5000..."
    # Find PIDs listening on these ports
    PIDS=$(lsof -ti :3000,5000 2>/dev/null || true)
    if [ -n "$PIDS" ]; then
        echo "‚ö†Ô∏è  Found processes occupying ports: $PIDS"
        echo "üí• Killing them..."
        # We use sudo implicitly if needed, or expect user to run as sudo if simple kill fails
        kill -9 $PIDS || sudo kill -9 $PIDS
        echo "‚úÖ Ports cleared."
    else
        echo "‚úÖ No blocking processes found."
    fi
    ;;
  test)
    ensure_env
    echo "Running test suites in Docker..."
    (cd "$SCRIPT_DIR" && ${COMPOSE} -f docker-compose.test.yml up --build --abort-on-container-exit)
    echo "‚úÖ Tests completed."
    ;;
  install)
    echo "Checking local prerequisites..."
    # Docker
    if command -v docker >/dev/null 2>&1; then
        echo "‚úÖ docker found: $(docker --version | head -n1)"
    else
        echo "‚ùå docker not found. Install Docker Engine: https://docs.docker.com/get-docker/"
    fi
    # Compose
    if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
        echo "‚úÖ docker compose plugin found: $(docker compose version | head -n1)"
    elif command -v docker-compose >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  legacy docker-compose found: $(docker-compose --version). Consider upgrading to docker compose plugin."
    else
        echo "‚ùå docker compose not found. Install: https://docs.docker.com/compose/install/"
    fi
    # Node/npm
    if command -v node >/dev/null 2>&1; then
        echo "‚úÖ node found: $(node -v)"
    else
        echo "‚ö†Ô∏è  node not found. For local builds/tests install Node 18+ (e.g., https://nodejs.org/en/download)"
    fi
    if command -v npm >/dev/null 2>&1; then
        echo "‚úÖ npm found: $(npm -v)"
    else
        echo "‚ö†Ô∏è  npm not found. It ships with Node; install Node 18+."
    fi
    # Optional: npx for gemini alias
    if command -v npx >/dev/null 2>&1; then
        echo "‚úÖ npx available."
    else
        echo "‚ö†Ô∏è  npx not found; install Node/npm to use Gemini CLI alias."
    fi
    echo "Check complete. Install missing dependencies above, then run './manage.sh up'."
    ;;
  agent)
    echo "Starting local agent CLI..."
    if [[ ! -f "$SCRIPT_DIR/server/.env" ]]; then
      echo "No server/.env found. Copying template..."
      cp "$SCRIPT_DIR/server/.env.template" "$SCRIPT_DIR/server/.env"
      echo "Update server/.env with your CLI_SECRET and run again if needed."
    fi
    (cd "$SCRIPT_DIR/server" && npm install && npm run agent:cli)
    ;;
  status)
    echo "Container status:"
    ${COMPOSE} ps
    echo ""
    echo "Log files (if present):"
    echo "  server: $SCRIPT_DIR/server.log"
    echo "  client: $SCRIPT_DIR/client.log"
    echo "  nginx : $SCRIPT_DIR/nginx/error.log"
    ;;
  *)
    usage
    ;;
esac
